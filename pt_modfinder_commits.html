<!-- extended version of https://yhvr.me/pt/modfinder.html -->
<!-- sorting JS mostly lifted from https://www.raymondcamden.com/2018/02/08/building-table-sorting-and-pagination-in-vuejs -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Modlist Tree</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue"></script>
    <style>
        * {
            font-family: "Inter", sans-serif;
        }

        td, th {
            padding-left: 5px;
        }

        th {
            cursor: pointer;
        }

        .updated {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>

<body>
    <h3>Prestige Tree Modfinder</h3>
    <p>Note: extended version of <a href="https://yhvr.me/pt/modfinder.html">https://yhvr.me/pt/modfinder.html</a><br />
    sorting JS mostly lifted from <a href="https://www.raymondcamden.com/2018/02/08/building-table-sorting-and-pagination-in-vuejs">https://www.raymondcamden.com/2018/02/08/building-table-sorting-and-pagination-in-vuejs</a></p>
    <p>heads up this makes HTTP requests to api.github.com</p>
    <div id="app">
        <p v-if="mods.length === 0">patience is a virtue</p>
        <table>
            <tr>
                <th></th>
                <th @click="sort('name')">Mod Name</th>
                <th>Alt Link</th>
                <th @click="sort('updated')">Updated</th>
                <th>Commit Message</th>
            </tr>
            <tr v-for="mod in sortedMods">
                <td><img :src="mod.owner.avatar_url" width="20" height="20"></td>
                <td><a :href="'https://' + mod.owner.login + '.github.io/' + mod.name + '/'">{{ mod.name }} by {{ mod.owner.login }}</a></td>
                <td><a :href="'https://raw.githack.com/' + mod.owner.login + '/' + mod.name + '/' + mod.default_branch + '/index.html'">alt link</a></td>
                <td class="updated">{{ mod.updated.toISOString() }}</td>
                <td>"{{ mod.commit.message }}"</td>
            </tr>
        </table>
        <br />sorted by: {{currentSort}} ({{currentSortDir}})
    </div>

    <script>
        //"use strict";
        // Init Vue app
        const app = new Vue({
            el:"#app",
            data:{
                mods:[],
                currentSort:"updated",
                currentSortDir:"desc"
            },
            created:function() {
                // Helper function for date flooring
                function roundMinutes(date) {
                    date = new Date(date);
                    date.setSeconds(0, 0);
                    return date;
                }

                function datesEq(a, b) {
                    return roundMinutes(a).toString() === roundMinutes(b).toString();
                }

                // Make `fetch`s to GitHub APIs
                fetch("https://api.github.com/repos/Jacorb90/Prestige-Tree/forks")
                    .then(res => res.json())
                    .then(json => {
                        json.forEach(repo => {
                            fetch(repo.url)
                                .then(res => res.json())
                                .then(repo => {
                                    if (!datesEq(repo.created_at, repo.updated_at)) {
                                        repo.updated = new Date(repo.updated_at);
                                        app.mods.push(repo);
                                    }
                                })
                        })
                    });

                fetch("https://api.github.com/repos/Acamaeda/The-Modding-Tree/forks")
                    .then(res => res.json())
                    .then(json => {
                        json.forEach(repo => {
                            fetch(repo.url)
                                .then(res => res.json())
                                .then(repo => {
                                    if (!datesEq(repo.created_at, repo.updated_at)) {
                                        repo.updated = new Date(repo.updated_at);
                                        app.mods.push(repo);
                                    }
                                })
                        })
                    });

                app.mods.forEach(repo => {
                    repo.commit_message = '';
                    fetch(repo.commits_url.replace('{/sha}',''))
                        .then(res => res.json())
                        .then(json => {
                            repo.commit_message = json[0].commit.message;
                        });
                    console.log(repo.commit_message);
                });
            },
            methods:{
                sort:function(s) {
                    //if s == current sort, reverse
                    if(s === this.currentSort) {
                        this.currentSortDir = this.currentSortDir==="asc"?"desc":"asc";
                    }
                    this.currentSort = s;
                }
            },
            computed:{
                sortedMods:function() {
                    return this.mods.sort((a,b) => {
                        let modifier = 1;
                        if(this.currentSortDir === "desc") modifier = -1;
                        if(a[this.currentSort] < b[this.currentSort]) return -1 * modifier;
                        if(a[this.currentSort] > b[this.currentSort]) return 1 * modifier;
                        return 0;
                    });
                }
            }
        })
    </script>
</body>

</html>